---
layout: post
title:  "Jenkins과 Maven을 사용하여 CI 적용하기"
date:   2021-07-01 00:00:07
categories: CI/CD
tags: CI/CD JENKINS
comments: 1
--- 

  &nbsp;프로젝트를 진행하면서 클라우드 서버에 배포하고 테스트하는 것이 굉장히 손이 많이 간다고 느껴졌다. 먼저 jar파일을 생성한 후에, FTP를 사용하여 서버에 올리고 스크립트를 통해서 jar파일을 실행하는 과정은 별 건 아니지만 매우 귀찮고 소모적이라고 생각이 들었다. 이것이 끝이 아니라 서버에서 실행된 어플리케이션이 정상적으로 작동하는 지를 `postman`으로 테스트해야 했다.
  <br>  
  &nbsp;이번 [스마트스토어 프로젝트](https://github.com/f-lab-edu/smart-store)처럼 다른 개발자와 협업을 하게되면, 각자 개발을 완료한 부분들이 충돌이나 오류없이 잘 구동이 되는지 테스트 할 일이 참 많다. 각자의 branch의 작업이 완료될 때마다 해당 branch를 local로 clone하고 build하고 테스트를 하는 것도 매우매우 번거로운 일이었다.  
 이러한 단순작업들을 자동화하기 위해 CI/CD를 적용해보기로 했다. 

간단하게 CI/CD에 대해서 간단하게 정리해 보면,<br>  
**CI(Continuous Integration)** <br> 
지속적인 통합이라는 의미로서 개발자가 개발한 코드를 빌드하고 테스트하는 행위를 자동화하는 것이다. <br> 

**CD(Continuous Delivery / Continuous Deployment)**   
지속적 배포라는 의미로서 빌드와 테스트가 완료된 후 배포하고자 하는 서버에 자동으로 배포하는 것이다. <br>  

자세한 설명은 [이곳](https://www.redhat.com/ko/topics/devops/what-is-ci-cd)을 참고하면 좋다.

<br>  
<p  align="center"><img src="https://user-images.githubusercontent.com/37571052/131462566-39f0a3d4-eabe-42e4-b833-29a57e8f5890.png"/></p>
<p align="center">지속적 통합 , 지속적 제공, 지속적 통합</p>  
<br>  
&nbsp;CI를 통해서 개발자들은 코드 변경 사항을 공유 브랜치 또는 트렁크로 병합하는 작업을 자주 그리고 쉽게 수행할 수 있게 된다. 어플리케이션에 적용한 변경 사항이 병합되면 이러한 변경 사항이 어플리케이션을 손상시키 이지 않고 자동으로 어플리케이션을 구축하게 되고, 테스트를 자도으로 실행하여 변경 사항이 어플리케이션에 제대로 적용이 되었는지 확인할 수 있다. <br>   
만일 자동화된 테스트에서 기존 코드와 신규 코드 간의 충돌이 발견되면 CI를 통해 이러한 버그를 발견하고 더 빠르게 자주 수정할 수도 있다.
   
CI를 통해서 개발된 코드가 서버에 전달됐다면 , 배포작업(CD)를 해야 한다. 배포준비가 완료된 빌드된 코드를 자동으로 릴리즈하는 지속적 배포는 어플리케이션을 프로덕션으로 릴리즈하는 작업을 자동으로 해준다.    

그리고 이러한 지속적 통합과 지속적 배포가 제대로 이루어지려면 마찬가지로 테스트 자동화가 제대로 설계되어 있어야 한다.

 
<br>  
이번 프로젝트에 CI/CD를 적용하기 위해 사용한 방식은 Jenkins와 Github를 연동하는 방식이다. <br>  
소스를 수정하여 Github에 push하면 Github에서 Jenkins에 event를 발생시켜주고, Jenkins는 Github으로부터 소스를 내려받아 Build를 자동으로 수행하여 Run하게 된다. 

**Jenkins 서버 설정** <br>  
위에서 말한 것처럼, Github에서 보내는 event 신호를 받으려면 24시간 대기 중인 Jenkins서버가 필요하다. <br>  
일단 학습을 위한 것이니 최대한 과금이 없는 방법으로 시도해보고자 했다. 방법을 찾던 중 local에서 jenkins를 실행하여 github와 연동하는 방법을 찾았다.
ngrok이라는 라이브러리를 사용하면 된다. 


이를 위해서 AWS, NCP 등을 고려해 봤지만, 아직은 학습을 위한 단계이기 때문에 부담없이 무료로 구축해보고 싶었다. 그래서 방법을 찾다가 local에서 
Github설정
Jenkins 파일 
Groovy 스크립트 
Docker를 사용하지 않고, 스크립트로 구현
화면 캡쳐



jenkins 사용하려면 독립적인 서버가 필요했다. 
처음에는 서버유지 비용이 우려되어서 local 서버를 외부 서버인 것처럼 사용할 수 있도록 하는
ngrok을 사용하여 jenkins를 사용해 봄. 
그러던 중 네이버 클라우드에서 가입 시 10만원 상당의 크레딧을 기본으로 제공해준다는 것을 알고,
ncp를 사용하여 jenkins서버를 구축했다.

소스를 수정하여 Github에 push하면 Github에서 jenkins에 event를 발생시켜주고, Jenkins는 Github으로부터 소스를 내려받아 Build를 자동으로 수행하여 Run하는 방법이 있다. 




Git : push ->  Github : webhook 전송 -> jenkins parameter parsing 및 branch 정보 확인 clean package 작업

Jenkins를 사용하겠다는 원대한 계획이 있었지만, 일단 Jenkins를 돌릴 서버가 필요했다. 
jenkins CI에 대한 여러 블로그 글들을 읽던 와중에 https://jojoldu.tistory.com/139글을 참고하여 일단 로컬에서 Jenkins서버를 사용하는 방법을 선택했다. 
Jenkins서버를 로컬 환경에서 Github와 연동하기 위해서는 localhost가 아닌 url이 필요한데 ngrok이라는 툴은 이것을 가능하게 해준다. 설치와 사용법도 어렵지 않아서 금방 적용할 수 있었다. 

연계를 구현하는 것이 1차적 목표였기 때문에, 아주 간단한 hello world를 출력하는 Java Project를 생성하여 git에 push하여 테스트하기로 했다. 
다만 이 프로젝트는 maven을 사용하지 않았기 때문에 echo 명령어로 간단한 문구를 출력되도록만 설정했다.

1차적 목적을 달성하여 연계가 잘 되는 것을 확인했고, 이제 그 다음 목표로 실제 상용 클라우드 서버에서 현재 진행중인 project에 적용해보기로 했다. 
처음 사용해보는 기술이지만 언젠가 실전에서도 익숙하게 사용하기 위해서는 최대한 비슷한 환경을 구성하여 사용해보는 것이 좋다고 생각했다. 
과거 개인 프로젝트에서 사용했던 AWS의 EC2를 다시 사용해볼까 했지만, 그 당시에 서버를 운영하면서 예상보다 많았던 지출이 있었던 기억이 있다.
게다가 현재 개발중인 스마트스토어 프로젝트는 CI/CD서버, WAS서버, DB서버(replication한다면 master-slave로 나뉘어 2개의 DB서버가 필요하게 된다.)가 필요하기 때문에 
무작정 과금을 하며 ec2를 사용하자니 청구될 금액이 걱정이었다. 

클라우드 서버를 알아보던 중 NCP(네이버 클라우드 플랫폼)의 경우 신규가입자에게 10만 크레딧(10만원 상당)을 제공한다는 사실을 알게 되었다. 
물론 10만 크레딧으로 24시간 풀로 몇날며칠 운영하는 것은 힘들 수 있겠지만, 기본적인 아키텍트를 구성하고 테스트하기에는 충분하다고 생각되었다. 

NCP에서 Jenkins CI용 서버를 생성하고 os는 ubuntu16.04를 설치한 후 Jenkins와 java, maven을 설치하였다. 

혼자 진행하는 프로젝트가 아니라 협업하는 프로젝트이기 때문에 처음 해보는 연계 테스트에 예상치 못한 사고를 칠까봐(네. 제가 겁이 많습니다..)
해당 repository에 바로 적용하지 않고, fork한 후에 동일한 소스로 진행했다. 
